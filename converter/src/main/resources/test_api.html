<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDL converter</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://malsup.github.io/jquery.form.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4 bg-primary rounded rounded-lg text-white">Convert WDL to Diagram or Nextflow</h2>
        <form id="myFormId" action="http://localhost:9998/diagrams/wdl/convert" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <input class="form-check-input" type="radio" name="wdlType" id="radio_wdl_file" value="file" checked>
                  <label class="form-check-label" for="radio_wdl_file">
                    File
                  </label>
                  <input class="form-check-input" type="radio" name="wdlType" id="radio_wdl_text" value="text">
                <label class="form-check-label" for="radio_wdl_text">
                  Plain text
                </label>
            </div>
            <div class="mb-3">
                <div class="from-group input_wdl_type_selector" id="div_file">
                <label for="input_wdl_file" class="form-label">Input file</label>
                <input type="file" class="form-control"  id="input_wdl_file" name="inputWdl">
                </div>
                <div class="form-group input_wdl_type_selector" id="div_text">
                <label for="input_wdl_text" class="form-label">WDL text</label>
                <textarea class="form-control" id="input_wdl_text" name="inputWdlText" rows="25"></textarea>
                </div>
            </div>
                        
             <button type="submit" id="submit_convert" class="btn btn-primary">Submit</button>
        </form>
    </div>
    <div class="container mt-5" id="result_content">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="diagram-tab" data-bs-toggle="tab" data-bs-target="#diagram" type="button" role="tab" aria-controls="diagram" aria-selected="true">Diagram</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="nextflow-tab" data-bs-toggle="tab" data-bs-target="#nextflow" type="button" role="tab" aria-controls="nextflow" aria-selected="false">Nextflow</button>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="diagram" role="tabpanel" aria-labelledby="diagram-tab">
        <img id="diagram_image"></img>
      </div>
      <div class="tab-pane fade" id="nextflow" role="tabpanel" aria-labelledby="nextflow-tab">
      <pre id="newxflow_result">
      </pre>  
    </div>
    </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" tabindex="-1" id="modal_file_size" aria-hidden="true" role="dialog" >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">File is too large</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>File size limit is 1MB. Please, select another file to convert.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal" tabindex="-1" id="modal_no_input" aria-hidden="true" role="dialog" >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Input is missed</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Please, select WDL file or paste WDL text to convert.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" tabindex="-1" id="modal_error" aria-hidden="true" role="dialog" >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title alert alert-danger">Server error</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="modal_error_message">
            <p>Error message</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <script>
          $(document).ready(function() {
              $(".input_wdl_type_selector").hide();
              
              $("input[name='wdlType']").click(function() {
                      var test = $(this).val();
                      $(".input_wdl_type_selector").hide();
                      $("#div_"+test).show();
                      $("#newxflow_result").text("");
                      $("#diagram_image").attr("src", "");
                      $("#result_content").hide();
                      $("#input_wdl_file").val("");
                      $("#submit_convert").removeAttr("disabled");
                  });
                  
              $("#input_wdl_file").bind('change', function() {
                if(this.files[0].size > 1024*1024)
                {
                    $("#modal_file_size").modal("show");
                    $("#submit_convert").attr("disabled","disabled");
                }
                else
                {
                    $("#submit_convert").removeAttr("disabled");
                }
              });
              
              $("#div_file").show();
              $("#result_content").hide();
              
              $('#convertType').on('change',function(){ 
                var test = $(this).val();
                if(test=="nextflow")
                    $("#diagram_output_type").hide();
                else
                    $("#diagram_output_type").show();
                    
            });
            
            document.forms['myFormId'].addEventListener('submit', (event) => {
                event.preventDefault();
                // TODO may be do something here to show user that form is being submitted
                
                
                $("#newxflow_result").text("");
                $("#diagram_image").attr("src", "");
                $("#result_content").hide();
                //return;
                let formData = new FormData(event.target);
                let formData2 = new FormData(event.target);
                let wdl = $("input[name='wdlType']:checked").val();
                if(wdl == 'file')
                {
                    if($("#input_wdl_file").get(0).files.length == 0)
                    {
                        $("#modal_no_input").modal("show");
                        return;
                    }
                    formData.delete("inputWdlText");
                    formData2.delete("inputWdlText");
                }
                else
                {
                    if($("#input_wdl_text").val().trim().length == 0)
                    {
                        $("#modal_no_input").modal("show");
                        return;
                    }
                    formData.delete("inputWdl");
                    formData2.delete("inputWdl");
                }
                const image = document.querySelector("#diagram_image");
                formData.append("convertType", "diagram");
                formData.append("outputType", "image");
                fetch(event.target.action, {
                    method: 'POST',
                    body:  formData
                }).then((response) => {
                    if (!response.ok) {
                      throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    if (response.headers.get("content-type") == "application/json") {
                        throw response;
                    }
                    else
                        return response.blob();// or response.text() or whatever the server sends
                }).then((blob) => {
                    const objectURL = URL.createObjectURL(blob);
                    image.src = objectURL;
                    $("#result_content").show();
                  }).catch((error) => {
                    if (error instanceof Error) {
                        return { error }
                      }
                    console.log("Error occurred");
                    try {
                        error.json().then(body => {
                            showResponseError(body.message);
                            console.log("message = "+body.message);
                        });
                    } catch (e) {
                        console.log("Error parsing promise");
                        console.log(error);
                    } 

                });
                formData2.append("convertType", "nextflow");
                fetch(event.target.action, {
                    method: 'POST',
                    body:  formData2
                }).then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    if (response.headers.get("content-type") == "application/json") {
                        throw response;
                    }
                    else
                        return response.text();
                }).then((body) => {
                    $("#newxflow_result").text(body);
                    $("#result_content").show();
                }).catch((error) => {
                    console.log("Error occurred");
                    if (error instanceof Error) {
                        return { error }
                      }
                    try {
                        error.json().then(body => {
                            showResponseError(body.message);
                            console.log("message = "+body.message);
                        });
                    } catch (e) {
                        console.log("Error parsing promise");
                        console.log(error);
                    }
                });
            });
                  
          });
          
        function showResponseError(message)
        {
            var isShown = $("#modal_error").hasClass('in') || $('.modal').hasClass('show');
            if(isShown)
            {
                var oldMessage = $("#modal_error_message").text().trim();
                var newMessage = message.trim();
                if(oldMessage == newMessage)
                {
                    return;
                }
                else
                {
                    $("#modal_error_message").text(oldMessage + "<br>" + message);
                }
            }
            else
            {
                $("#modal_error_message").text(message);
                $("#modal_error").modal("show");
            }
        }
      </script>

    <!-- Bootstrap JS (optional, for certain components like dropdowns, modals, etc.) -->
    
</body>
</html> 